@page "/search"
@inject NavigationManager NavManager
@inject Data.DataCart DataCart
@using pleaseWork.Data
@using Models
@using Newtonsoft.Json;

<MudTextField @bind-Value="@search_text" @onkeydown="@Enter" Label="Search" Variant="Variant.Filled"></MudTextField>

<MudTabs Elevation="2" Rounded="true" Centered="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
    <MudTabPanel Text="Produce">
        <MudGrid Spacing="2" Class="mt-2" Justify="Justify.Center">
            @if (Products == null || Products.Count == 0)
            {
                <MudText Typo="Typo.body2">No results found.</MudText>
            }
            else
            {
                foreach (Models.Product product in Products)
                {
                    <MudItem>
                        <MudCard Elevation="10" Height="180px" Width="172px">
                            <MudPaper Height="110px" Width="172px" />
                            <MudCardContent>
                                <MudText>@product.name</MudText>
                                <MudText Typo="Typo.body2">@product.price</MudText>
                                <MudText Typo="Typo.body2" id="seller">@product.seller</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            }
        </MudGrid>
    </MudTabPanel>
    <MudTabPanel Text="Farmers">
        <MudGrid Spacing="2" Class="mt-2" Justify="Justify.Center">
            @if (Farmers == null || Farmers.Count == 0)
            {
                <MudText Typo="Typo.body2">No results found.</MudText>
            }
            else
            {
                foreach (var farmer in Farmers)
                {
                    <MudItem>
                        <MudCard Elevation="10" Height="180px" Width="172px">
                            <MudPaper Height="110px" Width="172px" />
                            <MudCardContent>
                                <MudText>@farmer</MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            }
        </MudGrid>
    </MudTabPanel>
</MudTabs>

@code {
    public string TextValue { get; set; }
    public List<Models.Product> Products = new List<Models.Product>();
    public List<string> Farmers = new List<string>();
    private MudTheme Theme = new MudTheme();

    string search_text = "";

    private async void Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await OnInitializedAsync();
        }
    }

    private void toProduct()
    {
        //Console.WriteLine(s);
        NavManager.NavigateTo("/product");
    }

    private async Task<List<Models.Product>> SearchProducts(string search_text)
    {
        HttpClient client = new HttpClient { BaseAddress = new Uri("https://farmersmercato.azurewebsites.net/api/search-products") };

        HttpResponseMessage response = null;
        response = await client.GetAsync(client.BaseAddress);

        var data = await response.Content.ReadAsStringAsync();

        List<Models.Product> products = new List<Models.Product>();
        products = JsonConvert.DeserializeObject<List<Models.Product>>(data);

        if (search_text != "")
        {
            List<Models.Product> filteredProducts = new List<Models.Product>();

            foreach (Models.Product product in products)
            {
                if (product.name.ToLower().Contains(search_text.ToLower()))
                {
                    filteredProducts.Add(product);
                }
            }

            products = filteredProducts;
        }

        return products;
    }

    private async Task<List<string>> SearchFarmers(string search_text)
    {
        HttpClient client = new HttpClient { BaseAddress = new Uri("https://farmersmercato.azurewebsites.net/api/search-farmers") };

        HttpResponseMessage response = null;
        response = await client.GetAsync(client.BaseAddress);

        var data = await response.Content.ReadAsStringAsync();
        dynamic accounts = JsonConvert.DeserializeObject(data);

        List<string> farmers = new List<string>();

        foreach (var account in accounts)
        {
            if (search_text == "")
            {
                farmers.Add((string)account.name);
            }
            else
            {
                if (account.name.ToString().ToLower().Contains(search_text.ToLower()))
                {
                    farmers.Add((string)account.name);
                }
            }
        }

        return farmers;
    }

    protected override async Task OnInitializedAsync()
    {
        Products = await SearchProducts(search_text);
        Farmers = await SearchFarmers(search_text);
    }
}

<style>
    #farmer-nav-bar {
        visibility: hidden;
    }

    #seller {
        visibility: hidden;
    }
</style>
